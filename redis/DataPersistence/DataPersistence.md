## 持久化
### AOF持久化
![img.png](imgs%2Fimg.png)
AOF持久化是通过保存写操作到磁盘日志来实现的  
写日志的操作也是主线程来执行的，那么应该什么时候执行才不会阻塞redis其他命令呢？
- 这里主要的问题就是写盘的IO操作速度很慢，如何选择合适的写盘时机
- 内核缓冲区的数据何时写回硬盘，有三种写盘策略
![img_2.png](imgs%2Fimg_2.png)
![img_1.png](imgs%2Fimg_1.png)
- 这三种写回策略都无法完美解决【主进程阻塞】和【减少数据丢失的问题】，因为这两者是对立的，偏向一边就会牺牲另外一边

- AOF重写机制
  - 当日志越来越多时，使用重写机制可以压缩AOF文件，eg set name liu 和 set name liuyize就可以用一条命令记录
  - 在AOF重写时，注意要将命令记录到新的AOF文件上，否则有可能污染原文件

- AOF后台重写
  - 当触发AOF重写时，这个过程是比较耗时的，所以由后台子进程 **bgrewriteaof** 完成
  ![img_4.png](imgs%2Fimg_4.png)

### RDB快照
RDB文件的内容是二进制数据
- redis的快照是全量快照，所以保存快照是一个比较重的操作，一般可能设置五分钟才保存一次快照
- 快照保存时，redis仍然可以继续执行命令，利用写时复制技术(copy on write)

### 混合持久化
当开启了混合持久化时，在 AOF 重写日志时，fork 出来的重写子进程会先将与主线程共享的内存数据以 RDB 方式写入到 AOF 文件，然后主线程处理的操作命令会被记录在重写缓冲区里，重写缓冲区里的增量命令会以 AOF 方式写入到 AOF 文件，写入完成后通知主进程将新的含有 RDB 格式和 AOF 格式的 AOF 文件替换旧的的 AOF 文件。
![img_5.png](imgs%2Fimg_5.png)